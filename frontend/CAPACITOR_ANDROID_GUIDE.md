# Capacitor Android Setup Guide

This guide explains how to build and run the OffSite Android app using Capacitor.

## Prerequisites

1. âœ… **Node.js** (v18 or higher)
2. âœ… **Android Studio** (latest version)
3. âœ… **Java Development Kit (JDK)** 17 or higher
4. âœ… **Android SDK** (installed via Android Studio)

## Project Structure

```
offsite/frontend/
â”œâ”€â”€ android/              # Android native project (generated by Capacitor)
â”œâ”€â”€ dist/                 # Web build output (served in Android app)
â”œâ”€â”€ src/                  # React source code
â”œâ”€â”€ capacitor.config.ts   # Capacitor configuration
â””â”€â”€ package.json          # Dependencies and scripts
```

## Quick Start

### 1. Build the Web App

```bash
cd offsite/frontend
npm run build
```

This creates the `dist/` folder with the production build.

### 2. Sync with Android

```bash
npm run cap:sync
```

This copies the `dist/` folder to the Android project and updates native dependencies.

### 3. Open in Android Studio

```bash
npm run cap:open:android
```

Or manually:
- Open Android Studio
- File â†’ Open â†’ Select `offsite/frontend/android/`

### 4. Run the App

1. Connect an Android device or start an emulator
2. Click the "Run" button in Android Studio
3. The app will install and launch on your device

## Available Scripts

```bash
# Build web app
npm run build

# Sync web build to Android
npm run cap:sync

# Build and sync in one command
npm run cap:build

# Open Android Studio
npm run cap:open:android
```

## Capacitor Configuration

The app is configured in `capacitor.config.ts`:

- **App ID:** `com.offsite.app`
- **App Name:** `OffSite`
- **Web Directory:** `dist`
- **Android Scheme:** `https` (for production)

## Native Features

The app uses the following Capacitor plugins:

### 1. Geolocation (`@capacitor/geolocation`)
- Used for GPS attendance check-in
- Automatically requests location permissions
- Falls back to browser API on web

### 2. Camera (`@capacitor/camera`)
- Used for DPR photo capture
- Supports camera and gallery
- Falls back to file input on web

### 3. Network (`@capacitor/network`)
- Detects online/offline status
- Automatically syncs when connection restored
- Falls back to `navigator.onLine` on web

### 4. Preferences (`@capacitor/preferences`)
- Secure storage for sensitive data (if needed)
- Available but not actively used yet

## Permissions

The Android app requires the following permissions (automatically configured):

- **Location** (`ACCESS_FINE_LOCATION`, `ACCESS_COARSE_LOCATION`)
  - Required for attendance GPS check-in

- **Camera** (`CAMERA`)
  - Required for DPR photo capture

- **Storage** (`READ_EXTERNAL_STORAGE`, `WRITE_EXTERNAL_STORAGE`)
  - Required for accessing photos from gallery

- **Internet** (`INTERNET`)
  - Required for API calls

## Building for Production

### Generate Signed APK

1. Open Android Studio
2. Build â†’ Generate Signed Bundle / APK
3. Choose APK
4. Create a new keystore (or use existing)
5. Select release build variant
6. Click Finish

### Generate AAB (for Google Play)

1. Build â†’ Generate Signed Bundle / APK
2. Choose Android App Bundle
3. Follow the same signing process
4. Upload the `.aab` file to Google Play Console

## Environment Variables

The app uses environment variables for the backend API URL:

- **Development:** `http://localhost:3000/api`
- **Production:** Set `VITE_API_URL` in build process

To set for Android build:

1. Create `.env.production` file:
```env
VITE_API_URL=https://your-backend.onrender.com/api
```

2. Build with production mode:
```bash
npm run build
```

## Troubleshooting

### Issue: Build fails with "Cannot find module"

**Solution:**
```bash
npm install
npm run build
npm run cap:sync
```

### Issue: App shows blank screen

**Solution:**
1. Check that `dist/` folder exists and has content
2. Run `npm run cap:sync` again
3. Rebuild in Android Studio

### Issue: Location permission denied

**Solution:**
1. Check AndroidManifest.xml has location permissions
2. Request permission at runtime (handled automatically by Capacitor)
3. Check device location settings

### Issue: Camera not working

**Solution:**
1. Check AndroidManifest.xml has camera permission
2. Ensure device has camera hardware
3. Check app permissions in device settings

### Issue: Network status not updating

**Solution:**
1. Check that `@capacitor/network` is installed
2. Verify network listener is set up in App.tsx
3. Test on real device (emulator may have network issues)

## Development Workflow

1. **Make code changes** in `src/`
2. **Build web app:** `npm run build`
3. **Sync to Android:** `npm run cap:sync`
4. **Test in Android Studio:** Run the app
5. **Repeat** as needed

## Testing

### Test on Emulator

1. Create Android Virtual Device (AVD) in Android Studio
2. Start emulator
3. Run app from Android Studio

### Test on Real Device

1. Enable Developer Options on Android device
2. Enable USB Debugging
3. Connect device via USB
4. Run app from Android Studio

## Backend Configuration

The Android app connects to the same backend as the web app:

- **Backend URL:** Set via `VITE_API_URL` environment variable
- **CORS:** Backend must allow requests from `capacitor://localhost`
- **HTTPS:** Required for production (Android enforces HTTPS)

Update backend CORS settings to include:
```
capacitor://localhost
http://localhost (development only)
```

## Code Structure

### Capacitor Integration Files

- `src/lib/capacitor.ts` - Platform detection utilities
- `src/lib/capacitor-geolocation.ts` - Geolocation wrapper
- `src/lib/capacitor-camera.ts` - Camera wrapper
- `src/lib/capacitor-network.ts` - Network status wrapper

### Updated Components

- `src/pages/AttendancePage.tsx` - Uses Capacitor geolocation
- `src/pages/DPRPage.tsx` - Uses Capacitor camera
- `src/App.tsx` - Uses Capacitor network status

All wrappers automatically fall back to browser APIs on web, ensuring the app works in both web and mobile.

## Next Steps

1. âœ… Capacitor installed and configured
2. âœ… Android platform added
3. âœ… Native plugins integrated
4. âœ… Build scripts added
5. ðŸ”„ Test on Android device/emulator
6. ðŸ”„ Build signed APK/AAB for distribution

## Support

For Capacitor documentation:
- https://capacitorjs.com/docs

For Android development:
- https://developer.android.com/

---

**The OffSite app is now ready for Android! ðŸš€**
