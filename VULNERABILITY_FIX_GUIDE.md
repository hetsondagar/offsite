# Vulnerability Fix Guide

## Current Situation

**10 vulnerabilities found** (4 moderate, 5 high, 1 critical) in frontend dependencies:

### Critical (1)
- **jspdf** (2.5.1) - Multiple vulnerabilities: ReDoS, DoS, Path Traversal
  - **Fix**: Update to 4.0.0 (major version update required)

### High (5)
- **react-router-dom** (6.30.1) - XSS via Open Redirects
  - **Fix**: Update to 6.31.0+
- **@remix-run/router** - XSS vulnerability (transitive via react-router-dom)
  - **Fix**: Will be fixed by updating react-router-dom
- **@capacitor/cli** (8.0.1) - Via tar dependency (path sanitization issues)
  - **Fix**: Wait for Capacitor team to update tar dependency, or use npm overrides
- **tar** - Arbitrary file overwrite and symlink poisoning (transitive via @capacitor/cli)
  - **Fix**: Will be fixed when @capacitor/cli updates

### Moderate (4)
- **vite** (5.4.19) - Via esbuild (development server vulnerability)
  - **Fix**: Update to 7.3.1 (major version update required)
- **esbuild** - Development server vulnerability (transitive via vite)
  - **Fix**: Will be fixed by updating vite
- **dompurify** - XSS vulnerability (transitive via jspdf)
  - **Fix**: Will be fixed by updating jspdf to 4.0.0
- **lodash** - Prototype pollution in `_.unset` and `_.omit` (transitive)
  - **Fix**: Update parent package or use npm overrides

## Immediate Fixes Applied

The following updates have been made to `frontend/package.json`:

1. ✅ **jspdf**: `^2.5.1` → `^4.0.0` (CRITICAL - fixes 3 vulnerabilities)
2. ✅ **react-router-dom**: `^6.30.1` → `^6.31.0` (HIGH - fixes XSS)
3. ✅ **vite**: `^5.4.19` → `^7.3.1` (MODERATE - fixes esbuild issue)

## Next Steps

### 1. Install Updated Dependencies

```bash
cd frontend
npm install
```

### 2. Handle Breaking Changes

#### jspdf 4.0.0 Breaking Changes
jsPDF 4.0.0 is a major version update with breaking changes. The import syntax has changed:

```typescript
// Old API (v2.x)
import jsPDF from 'jspdf';
const doc = new jsPDF();

// New API (v4.x)
import { jsPDF } from 'jspdf';
const doc = new jsPDF();
```

**Action**: ✅ Updated in `InvoiceCard.tsx` and `jspdf.d.ts`

#### Vite 7.3.1 Breaking Changes
Vite 7.x has breaking changes from 5.x. Check:
- Build configuration compatibility
- Plugin compatibility
- Import/export syntax

**Action**: Test build process thoroughly after update.

### 3. Fix Remaining Vulnerabilities

#### @capacitor/cli tar vulnerability
The tar vulnerability in @capacitor/cli requires either:
- Wait for Capacitor team to release an update
- Use npm overrides (add to package.json):

```json
{
  "overrides": {
    "tar": "^7.5.4"
  }
}
```

#### lodash prototype pollution
If lodash is used directly, update it. If it's transitive, add override:

```json
{
  "overrides": {
    "lodash": "^4.17.23"
  }
}
```

### 3. Update Specific Packages

Based on common vulnerabilities, update these packages:

```bash
cd frontend
npm install axios@latest
npm install html2canvas@latest
npm install jspdf@latest
```

```bash
cd backend
npm install express@latest
npm install mongoose@latest
npm install jsonwebtoken@latest
npm install bcrypt@latest
```

### 4. Run Full Audit

```bash
# Frontend
cd frontend
npm audit
npm audit --production  # Check production dependencies only

# Backend
cd backend
npm audit
npm audit --production
```

### 5. Use npm audit fix

```bash
# Frontend
cd frontend
npm audit fix

# Backend
cd backend
npm audit fix
```

### 6. Check Vercel Build Configuration

Ensure `vercel.json` is configured correctly to exclude dev dependencies:

```json
{
  "installCommand": "npm install --production=false",
  // or explicitly exclude dev deps if not needed
}
```

### 7. Update package-lock.json

After updating packages, commit the updated `package-lock.json`:

```bash
git add package-lock.json
git commit -m "fix: update dependencies to resolve security vulnerabilities"
```

## Common Vulnerabilities and Fixes

### axios
- **Issue**: Potential DoS in older versions
- **Fix**: Already on 1.13.2 (safe), but check for 1.7.x+ if issues persist

### express
- **Issue**: Various CVEs in older versions
- **Fix**: 4.18.2 is relatively safe, but consider 5.x upgrade path

### mongoose
- **Issue**: Prototype pollution risks
- **Fix**: Update to latest 8.x patch version

### jsonwebtoken
- **Issue**: Algorithm confusion attacks
- **Fix**: Ensure using latest 9.x with proper algorithm specification

## Verification Steps

1. **Local Audit**:
   ```bash
   npm audit
   npm audit --production
   ```

2. **Vercel Build**:
   - Push changes and check build logs
   - Verify vulnerability count decreases

3. **Test Application**:
   - Run full test suite
   - Verify all features work after updates

## Automated Security Scanning

Consider adding automated security scanning:

1. **GitHub Dependabot** - Automatic PRs for security updates
2. **Snyk** - Continuous security monitoring
3. **npm audit in CI/CD** - Fail builds if critical vulnerabilities found

## Notes

- Some vulnerabilities might be in dev dependencies (TypeScript, ESLint, etc.) which don't affect production
- Transitive dependencies might require updating parent packages
- Always test thoroughly after updating dependencies
- Keep `package-lock.json` committed to ensure consistent installs

## Next Steps

1. Run `npm update` in both frontend and backend
2. Run `npm audit fix` to automatically fix what can be fixed
3. Manually update packages with known vulnerabilities
4. Test the application thoroughly
5. Commit updated `package-lock.json` files
6. Deploy and verify Vercel build shows reduced vulnerabilities
